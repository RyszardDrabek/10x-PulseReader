---
import GlobalLayout from "../layouts/GlobalLayout.astro";
import App from "../components/App.tsx";
import Homepage from "../components/Homepage.tsx";
import { ArticleService } from "../lib/services/article.service";

const supabase = Astro.locals.supabase;
let initialArticles;

// Fetch articles server-side if Supabase is available
if (supabase) {
  try {
    const articleService = new ArticleService(supabase);
    initialArticles = await articleService.getArticles({
      limit: 20,
      offset: 0,
      sortBy: "publication_date",
      sortOrder: "desc",
    });
  } catch (error) {
    // If server-side fetch fails, provide empty data - client will fetch
    // eslint-disable-next-line no-console
    console.error("[index.astro] Failed to load articles server-side:", error);
    initialArticles = {
      data: [],
      pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
      filtersApplied: { sentiment: undefined, personalization: false },
    };
  }
} else {
  // If Supabase is not available, provide empty data - client will fetch
  initialArticles = {
    data: [],
    pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
    filtersApplied: { sentiment: undefined, personalization: false },
  };
}

// Pass environment variables to client components
const supabaseConfig = {
  url: import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL,
  key: import.meta.env.PUBLIC_SUPABASE_KEY || import.meta.env.SUPABASE_KEY,
};
---

<GlobalLayout title="PulseReader - Your Personalized News Feed">
  <div style="min-height: 100vh;">
    <App client:only="react" initialSession={null} supabaseConfig={supabaseConfig}>
      <Homepage client:only="react" initialData={initialArticles} />
    </App>
  </div>
</GlobalLayout>
