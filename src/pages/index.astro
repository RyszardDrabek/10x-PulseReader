---
import GlobalLayout from "../layouts/GlobalLayout.astro";
import App from "../components/App.tsx";
import Homepage from "../components/Homepage.tsx";
import { ArticleService } from "../lib/services/article.service";

// Use environment variables for Supabase client
const { createClient } = await import("@supabase/supabase-js");

// For production, use environment variables
// For local development, use the known working local Supabase instance
const isProduction = import.meta.env.PROD || import.meta.env.NODE_ENV === "production";
let supabaseUrl: string;
let supabaseKey: string;

if (isProduction) {
  // In production, use environment variables
  supabaseUrl = import.meta.env.SUPABASE_URL || import.meta.env.PUBLIC_SUPABASE_URL;
  supabaseKey = import.meta.env.SUPABASE_KEY || import.meta.env.PUBLIC_SUPABASE_KEY;
} else {
  // In local development, use known working local instance
  supabaseUrl = "http://127.0.0.1:18785";
  supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0";
}

let supabase = null;
if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
}
let initialArticles;

// Fetch articles server-side if Supabase is available
if (supabase) {
  try {
    const articleService = new ArticleService(supabase);
    // Get user from Astro locals for server-side rendering
    const userId = Astro.locals.user?.id;
    // eslint-disable-next-line no-console
    console.log("[index.astro] Server-side article fetch:", {
      hasUser: !!userId,
      userId: userId,
    });

    // Get user profile to check personalization settings
    let shouldApplyPersonalization = false;
    if (userId) {
      try {
        const userProfile = await articleService.getProfile(userId);
        shouldApplyPersonalization = userProfile?.personalizationEnabled ?? true;
      } catch (profileError) {
        // If profile fetch fails, default to personalization enabled (matches ArticleService behavior)
        // eslint-disable-next-line no-console
        console.warn("[index.astro] Failed to fetch user profile:", profileError);
        shouldApplyPersonalization = true;
      }
    }

    initialArticles = await articleService.getArticles(
      {
        limit: 20,
        offset: 0,
        sortBy: "publication_date",
        sortOrder: "desc",
        applyPersonalization: shouldApplyPersonalization,
      },
      userId
    );
  } catch (error) {
    // If server-side fetch fails, provide empty data - client will fetch
    // eslint-disable-next-line no-console
    console.error("[index.astro] Failed to load articles server-side:", error);
    initialArticles = {
      data: [],
      pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
      filtersApplied: { sentiment: undefined, personalization: false },
    };
  }
} else {
  // If Supabase is not available, provide empty data - client will fetch
  initialArticles = {
    data: [],
    pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
    filtersApplied: { sentiment: undefined, personalization: false },
  };
}

// Get current session for client-side initialization
// Use the same server client creation as middleware to access cookies
let initialSession = null;
try {
  const { createSupabaseServerInstance } = await import("../db/supabase.client.ts");
  const serverSupabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

  // eslint-disable-next-line no-console
  console.log("[index.astro] Getting session from server-side Supabase...");
  const {
    data: { session },
    error,
  } = await serverSupabase.auth.getSession();
  // eslint-disable-next-line no-console
  console.log("[index.astro] Server session result:", {
    hasSession: !!session,
    sessionUserId: session?.user?.id,
    sessionUserEmail: session?.user?.email,
    error: error?.message,
  });
  initialSession = session;
} catch (error) {
  // If session retrieval fails, continue without initial session
  // eslint-disable-next-line no-console
  console.error("[index.astro] Failed to get session:", error);
}

// Pass environment variables and session to client components
const supabaseConfig = {
  url: import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL,
  key: import.meta.env.PUBLIC_SUPABASE_KEY || import.meta.env.SUPABASE_KEY,
};
---

<GlobalLayout title="PulseReader - Your Personalized News Feed">
  <div style="min-height: 100vh;">
    <App client:only="react" initialSession={initialSession} supabaseConfig={supabaseConfig}>
      <Homepage client:only="react" initialData={initialArticles} />
    </App>
  </div>
</GlobalLayout>
