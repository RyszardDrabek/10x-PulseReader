---
/* eslint-disable no-console */
import GlobalLayout from "../layouts/GlobalLayout.astro";
import App from "../components/App.tsx";
import Homepage from "../components/Homepage.tsx";
import { ArticleService } from "../lib/services/article.service";

console.log("[index.astro] Starting page render");
console.log("[index.astro] typeof window:", typeof window);
console.log("[index.astro] typeof global:", typeof global);
console.log("[index.astro] import.meta.env.MODE:", import.meta.env.MODE);
console.log("[index.astro] import.meta.env.SSR:", import.meta.env.SSR);

try {
  console.log("[index.astro] About to import components");
  console.log("[index.astro] App component:", typeof App);
  console.log("[index.astro] Homepage component:", typeof Homepage);
} catch (error) {
  console.error("[index.astro] Error importing components:", error);
  throw error;
}

const supabase = Astro.locals.supabase;
const articleService = new ArticleService(supabase);

let initialArticles;
try {
  initialArticles = await articleService.getArticles({ limit: 20, offset: 0 });
} catch (error) {
  console.error("Failed to load articles:", error);
  // Provide fallback empty data
  initialArticles = {
    data: [],
    pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
    filtersApplied: { sentiment: undefined, personalization: false },
  };
}

// Pass environment variables to client components
const supabaseConfig = {
  url: import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL,
  key: import.meta.env.PUBLIC_SUPABASE_KEY || import.meta.env.SUPABASE_KEY,
};
---

<GlobalLayout title="PulseReader - Your Personalized News Feed">
  <div style="min-height: 100vh;">
    <App client:only="react" initialSession={null} supabaseConfig={supabaseConfig}>
      <Homepage initialData={initialArticles} />
    </App>
  </div>
</GlobalLayout>
/* eslint-enable no-console */
