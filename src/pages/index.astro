---
import GlobalLayout from "../layouts/GlobalLayout.astro";
import App from "../components/App.tsx";
import Homepage from "../components/Homepage.tsx";
import { ArticleService } from "../lib/services/article.service";

const supabase = Astro.locals.supabase;
const articleService = new ArticleService(supabase);

let initialArticles;
try {
  initialArticles = await articleService.getArticles({ limit: 20, offset: 0 });
} catch (error) {
  console.error("Failed to load articles:", error);
  // Provide fallback empty data
  initialArticles = {
    data: [],
    pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
    filtersApplied: { sentiment: undefined, personalization: false },
  };
}

// Pass environment variables to client components
const supabaseConfig = {
  url: import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL,
  key: import.meta.env.PUBLIC_SUPABASE_KEY || import.meta.env.SUPABASE_KEY,
};
---

<GlobalLayout title="PulseReader - Your Personalized News Feed">
  <div style="min-height: 100vh;">
    <App client:only="react" initialSession={null} supabaseConfig={supabaseConfig}>
      <Homepage initialData={initialArticles} />
    </App>
  </div>
</GlobalLayout>
