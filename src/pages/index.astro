---
import GlobalLayout from "../layouts/GlobalLayout.astro";
import App from "../components/App.tsx";
import Homepage from "../components/Homepage.tsx";
import { ArticleService } from "../lib/services/article.service";

// Use environment variables for Supabase client
const { createClient } = await import("@supabase/supabase-js");
const supabaseUrl = import.meta.env.SUPABASE_URL || import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.SUPABASE_KEY || import.meta.env.PUBLIC_SUPABASE_KEY;

console.log("[index.astro] Environment variables check:", {
  SUPABASE_URL: !!import.meta.env.SUPABASE_URL,
  PUBLIC_SUPABASE_URL: !!import.meta.env.PUBLIC_SUPABASE_URL,
  SUPABASE_KEY: !!import.meta.env.SUPABASE_KEY,
  PUBLIC_SUPABASE_KEY: !!import.meta.env.PUBLIC_SUPABASE_KEY,
  supabaseUrl: supabaseUrl ? "present" : "missing",
  supabaseKey: supabaseKey ? "present" : "missing",
});

let supabase = null;
if (supabaseUrl && supabaseKey) {
  console.log("[index.astro] Creating Supabase client with URL:", supabaseUrl.substring(0, 20) + "...");
  supabase = createClient(supabaseUrl, supabaseKey);
} else {
  console.log("[index.astro] Cannot create Supabase client - missing credentials");
}
let initialArticles;

// Fetch articles server-side if Supabase is available
console.log("[index.astro] Starting server-side article fetch");
console.log("[index.astro] Supabase available:", !!supabase);

if (supabase) {
  try {
    console.log("[index.astro] Creating ArticleService");
    const articleService = new ArticleService(supabase);
    console.log("[index.astro] Calling getArticles");

    initialArticles = await articleService.getArticles({
      limit: 20,
      offset: 0,
      sortBy: "publication_date",
      sortOrder: "desc",
    });

    console.log("[index.astro] Articles fetched successfully:", {
      count: initialArticles?.data?.length || 0,
      total: initialArticles?.pagination?.total || 0,
      hasMore: initialArticles?.pagination?.hasMore || false,
    });
  } catch (error) {
    // If server-side fetch fails, provide empty data - client will fetch
    // eslint-disable-next-line no-console
    console.error("[index.astro] Failed to load articles server-side:", error);
    console.error("[index.astro] Error details:", {
      message: error.message,
      stack: error.stack,
      name: error.name,
    });
    initialArticles = {
      data: [],
      pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
      filtersApplied: { sentiment: undefined, personalization: false },
    };
  }
} else {
  console.log("[index.astro] Supabase not available, using empty data");
  // If Supabase is not available, provide empty data - client will fetch
  initialArticles = {
    data: [],
    pagination: { limit: 20, offset: 0, total: 0, hasMore: false },
    filtersApplied: { sentiment: undefined, personalization: false },
  };
}

console.log("[index.astro] Final initialArticles:", {
  hasData: !!initialArticles,
  dataLength: initialArticles?.data?.length || 0,
  total: initialArticles?.pagination?.total || 0,
});

// Pass environment variables to client components
const supabaseConfig = {
  url: import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL,
  key: import.meta.env.PUBLIC_SUPABASE_KEY || import.meta.env.SUPABASE_KEY,
};
---

<GlobalLayout title="PulseReader - Your Personalized News Feed">
  <div style="min-height: 100vh;">
    <App client:only="react" initialSession={null} supabaseConfig={supabaseConfig}>
      <Homepage client:only="react" initialData={initialArticles} />
    </App>
  </div>
</GlobalLayout>
